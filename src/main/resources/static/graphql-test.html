<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GraphQL 测试工具</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.1.3/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .query-editor {
            height: 300px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
        }
        .result-display {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 1rem;
            max-height: 400px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 14px;
        }
        .example-queries {
            background: #f8f9fa;
            border-radius: 4px;
            padding: 1rem;
            margin-bottom: 1rem;
        }
        .example-query {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 0.5rem;
            margin: 0.5rem 0;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .example-query:hover {
            background-color: #e9ecef;
        }
        .example-query pre {
            margin: 0;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container-fluid py-4">
        <div class="row">
            <div class="col-12">
                <h2>GraphQL 测试工具</h2>
                <p class="text-muted">测试您配置的动态GraphQL查询</p>
            </div>
        </div>

        <div class="row">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">GraphQL 查询</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="graphqlQuery" class="form-label">查询语句</label>
                            <textarea 
                                class="form-control query-editor" 
                                id="graphqlQuery" 
                                placeholder="输入您的 GraphQL 查询...&#10;&#10;示例:&#10;query {&#10;  hello&#10;}"></textarea>
                        </div>
                        
                        <div class="mb-3">
                            <label for="graphqlVariables" class="form-label">变量 (可选，JSON格式)</label>
                            <textarea 
                                class="form-control" 
                                id="graphqlVariables" 
                                rows="3"
                                placeholder='{"userId": 1, "name": "张三"}'></textarea>
                        </div>

                        <div class="d-grid gap-2 d-md-flex">
                            <button class="btn btn-primary" id="executeBtn">执行查询</button>
                            <button class="btn btn-secondary" id="clearBtn">清空</button>
                            <button class="btn btn-outline-info" id="introspectionBtn">Schema查询</button>
                        </div>
                    </div>
                </div>

                <div class="card mt-3">
                    <div class="card-header">
                        <h5 class="mb-0">查询结果</h5>
                    </div>
                    <div class="card-body">
                        <div id="resultDisplay" class="result-display">
                            <div class="text-muted">执行查询后结果将显示在这里...</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">示例查询</h5>
                    </div>
                    <div class="card-body">
                        <div class="example-queries">
                            <h6>基础查询</h6>
                            <div class="example-query" onclick="setQuery(this)">
                                <strong>简单查询</strong>
                                <pre>{
  __typename
}</pre>
                            </div>
                            
                            <div class="example-query" onclick="setQuery(this)">
                                <strong>Schema查询</strong>
                                <pre>{
  __schema {
    types {
      name
      kind
    }
  }
}</pre>
                            </div>

                            <h6 class="mt-3">动态查询示例</h6>
                            <div class="example-query" onclick="setQuery(this)">
                                <strong>用户查询 (需要配置)</strong>
                                <pre>query GetUser($userId: ID!) {
  getUserById(userId: $userId) {
    id
    name
    email
  }
}</pre>
                            </div>

                            <div class="example-query" onclick="setQuery(this)">
                                <strong>用户列表 (需要配置)</strong>
                                <pre>query {
  getAllUsers {
    id
    name
    email
    createdAt
  }
}</pre>
                            </div>

                            <div class="example-query" onclick="setQuery(this)">
                                <strong>创建用户 (需要配置)</strong>
                                <pre>mutation CreateUser($name: String!, $email: String!) {
  createUser(name: $name, email: $email) {
    success
    affected
  }
}</pre>
                            </div>
                        </div>

                        <div class="mt-3">
                            <h6>说明</h6>
                            <ul class="small text-muted">
                                <li>点击示例查询可以快速填入</li>
                                <li>动态查询需要先在配置页面创建对应的resolver</li>
                                <li>使用变量时，请在变量框中输入JSON格式的数据</li>
                                <li>查询结果会显示在左侧结果面板中</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.1.3/js/bootstrap.bundle.min.js"></script>
    <script>
        const executeBtn = document.getElementById('executeBtn');
        const clearBtn = document.getElementById('clearBtn');
        const introspectionBtn = document.getElementById('introspectionBtn');
        const queryTextarea = document.getElementById('graphqlQuery');
        const variablesTextarea = document.getElementById('graphqlVariables');
        const resultDisplay = document.getElementById('resultDisplay');

        executeBtn.addEventListener('click', executeQuery);
        clearBtn.addEventListener('click', clearQuery);
        introspectionBtn.addEventListener('click', introspectionQuery);

        async function executeQuery() {
            const query = queryTextarea.value.trim();
            if (!query) {
                showError('请输入GraphQL查询语句');
                return;
            }

            const variables = variablesTextarea.value.trim();
            let parsedVariables = {};

            if (variables) {
                try {
                    parsedVariables = JSON.parse(variables);
                } catch (e) {
                    showError('变量JSON格式错误: ' + e.message);
                    return;
                }
            }

            executeBtn.disabled = true;
            executeBtn.textContent = '执行中...';

            try {
                const response = await fetch('/graphql', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        query: query,
                        variables: parsedVariables
                    })
                });

                const result = await response.json();
                displayResult(result);

            } catch (error) {
                showError('网络错误: ' + error.message);
            } finally {
                executeBtn.disabled = false;
                executeBtn.textContent = '执行查询';
            }
        }

        function introspectionQuery() {
            const introspection = `{
  __schema {
    types {
      name
      kind
      description
      fields {
        name
        type {
          name
          kind
        }
      }
    }
    queryType {
      name
      fields {
        name
        args {
          name
          type {
            name
            kind
          }
        }
      }
    }
    mutationType {
      name
      fields {
        name
        args {
          name
          type {
            name
            kind
          }
        }
      }
    }
  }
}`;
            queryTextarea.value = introspection;
            variablesTextarea.value = '';
        }

        function clearQuery() {
            queryTextarea.value = '';
            variablesTextarea.value = '';
            resultDisplay.innerHTML = '<div class="text-muted">执行查询后结果将显示在这里...</div>';
        }

        function setQuery(element) {
            const preElement = element.querySelector('pre');
            if (preElement) {
                queryTextarea.value = preElement.textContent;
                
                // 如果是mutation示例，自动填入示例变量
                if (preElement.textContent.includes('CreateUser')) {
                    variablesTextarea.value = '{\n  "name": "测试用户",\n  "email": "test@example.com"\n}';
                } else if (preElement.textContent.includes('GetUser')) {
                    variablesTextarea.value = '{\n  "userId": "1"\n}';
                } else {
                    variablesTextarea.value = '';
                }
            }
        }

        function displayResult(result) {
            const resultHtml = `<pre>${JSON.stringify(result, null, 2)}</pre>`;
            resultDisplay.innerHTML = resultHtml;

            // 根据结果类型添加不同的样式
            if (result.errors) {
                resultDisplay.className = 'result-display border-danger';
            } else if (result.data) {
                resultDisplay.className = 'result-display border-success';
            } else {
                resultDisplay.className = 'result-display';
            }
        }

        function showError(message) {
            const errorResult = {
                errors: [{
                    message: message
                }]
            };
            displayResult(errorResult);
        }

        // 键盘快捷键
        document.addEventListener('keydown', function(e) {
            if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                e.preventDefault();
                executeQuery();
            }
        });
    </script>
</body>
</html>