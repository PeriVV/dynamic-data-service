<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" />
    <title>数据库表浏览</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet" />
    <style>
        /* 统一字段详情/数据预览表格的视觉风格 */
        .data-table thead th{
          position: sticky; top: 0; z-index: 4;
          background: var(--thead);
          border-bottom: 1px solid var(--border);
          color: #3a4a66;
        }
        .data-table.table-bordered{ border-color: var(--border); }
        .data-table.table-striped>tbody>tr:nth-of-type(odd){ --bs-table-accent-bg:#fafcff; }

        /* ===== 浅色主题变量 ===== */
        :root{
          --bg: #f7f8fb;
          --card: #ffffff;
          --card-2: #ffffff;
          --muted: #5b667a;
          --border: #e4e7ee;
          --acc: #2563eb;   /* 主色：蓝 */
          --acc-2:#16a34a;  /* 成功色：绿 */
          --thead: #f2f5fb; /* 表头背景 */
          --chip: #f6f8fc;
          --text: #0f172a;  /* 主文本 */
          --text-weak:#314160;
        }
        html,body{height:100%;}
        body{
          background:
            radial-gradient(1200px 600px at 20% -10%, #eff4ff 0%, transparent 60%),
            radial-gradient(1200px 800px at 120% 0%, #eef3ff 0%, transparent 50%),
            var(--bg);
          color: var(--text);
          padding: 28px 24px;
        }
        .glass{ background: #ffffffa6; border:1px solid var(--border); border-radius:16px; backdrop-filter: blur(4px); }
        .page-title{ display:flex; align-items:center; gap:12px; margin-bottom:18px; }
        .page-title .badge{ letter-spacing:.5px; }
        .subtle{ color:var(--muted); font-size:.95rem; }

        .card-lite{ background:var(--card); border:1px solid var(--border); border-radius:14px; }
        .card-darker{ background:var(--card-2); border:1px solid var(--border); border-radius:14px; }
        .card-header{ background:linear-gradient(180deg,#fff, #fafbff); border-bottom:1px solid var(--border); position: sticky; top:0; z-index:5; backdrop-filter: blur(2px); }

        .side{ height: calc(100vh - 140px); display:flex; flex-direction:column; gap:12px; }

        .search{ background:#fff; border:1px solid var(--border); color:var(--text); }
        .table-list{ overflow:auto; border-radius:10px; border:1px solid var(--border); background:#fff; height:100%; }
        .table-list-item{
          padding:.65rem .8rem; display:flex; align-items:center; gap:10px;
          border-bottom:1px solid #f0f2f7; cursor:pointer; transition: background .15s;
        }
        .table-list-item:hover{ background:#f7faff; }
        .table-list-item.active{ background:#e8f0ff; }
        .table-list-item .name{font-weight:600; color:var(--text);}
        .table-list-item .meta{font-size:.78rem; color:var(--muted);}
        .icon-chip{
          width:26px; height:26px; display:grid; place-items:center;
          border-radius:8px; background:var(--chip); border:1px solid var(--border); color:#3b82f6;
        }

        .toolbar .btn{ border-color:var(--border); }
        .toolbar .form-select,.toolbar .form-control{ background:#fff; color:var(--text); border-color:var(--border); }

        table thead th{
          position: sticky; top:0; z-index:4; background:var(--thead);
          border-bottom:1px solid var(--border);
        }
        .table>:not(caption)>*>*{ background:transparent; }

        .skeleton{
          background: linear-gradient(90deg, #eef2f9, #e6ebf6, #eef2f9);
          background-size: 200% 100%;
          animation: shimmer 1.2s infinite;
          border-radius:8px; height:16px;
        }
        @keyframes shimmer{ 0%{background-position:200% 0} 100%{background-position:-200% 0} }

        .empty{ text-align:center; color:var(--muted); padding:32px 12px; }
        .pill{
          display:inline-flex; align-items:center; gap:6px; padding:.35rem .6rem;
          border:1px solid var(--border); border-radius:999px; background:#fff; color:var(--text-weak);
          font-size:.85rem;
        }
        .muted{ color:var(--muted); }
        .text-acc{ color:var(--acc); }
        .divider{ border-top:1px dashed var(--border); margin:10px 0; }
        .btn-acc{ background:var(--acc); border:none; color:white; }
        .btn-acc:hover{ filter:brightness(1.05); }
        .btn-ghost{ background:#fff; color:var(--text); border:1px solid var(--border); }
        .sticky-cta{ position:sticky; bottom:0; background:linear-gradient(180deg, transparent, #ffffffc0); padding-top:10px; }

        /* 表格颜色微调 */
        .table-striped>tbody>tr:nth-of-type(odd) { --bs-table-accent-bg: #fafcff; }
        .table-bordered { border-color: var(--border); }
        .table thead th{ color:#3a4a66; }
        .text-weak { color:#5f6e86; }
    </style>
</head>
<body>
<div class="container-fluid">
    <!-- Header + 返回主页 -->
    <div class="d-flex justify-content-between align-items-center">
        <div class="page-title">
            <span class="pill"><i class="fa-solid fa-database"></i> 数据表浏览</span>
            <span class="badge bg-primary-subtle text-primary border border-primary">Beta</span>
        </div>
        <button id="goHomeBtn" class="btn btn-ghost">
            <i class="fa-solid fa-house me-1"></i> 返回主页
        </button>
    </div>
    <p class="subtle mb-4">选择数据源与数据表，右侧将展示<strong class="text-acc">字段结构</strong>和<strong class="text-acc">数据预览</strong>。支持排序、分页与 CSV 导出。</p>

    <div class="row g-3">
        <!-- 左侧：表清单 -->
        <div class="col-12 col-lg-4">
            <div class="side">
                <div class="card-lite p-3">
                    <div class="d-flex align-items-center justify-content-between mb-2">
                        <div class="d-flex align-items-center gap-2">
                            <i class="fa-solid fa-plug text-primary"></i>
                            <span class="muted">选择数据源</span>
                        </div>
                        <span id="dsBadge" class="pill"><i class="fa-solid fa-circle-dot"></i> <span id="dsBadgeText">MYSQL</span></span>
                    </div>
                    <select id="dsSelect" class="form-select search">
                        <option value="MYSQL">MySQL</option>
                        <option value="DM8">DM8</option>
                    </select>
                    <div class="divider"></div>
                    <div class="d-flex align-items-center justify-content-between mb-2">
                        <span class="muted"><i class="fa-solid fa-table-list me-1"></i> 表列表</span>
                        <span id="tableCount" class="pill"><i class="fa-solid fa-hashtag"></i> 0</span>
                    </div>
                    <div class="d-flex gap-2 mb-2">
                        <input id="tableSearch" class="form-control search" placeholder="搜索表名..." />
                    </div>
                    <div class="d-flex gap-2">
                        <button id="newTableBtn" class="btn btn-acc btn-sm flex-grow-1">
                            <i class="fa-solid fa-plus me-1"></i> 新建表
                        </button>
                        <button id="refreshTablesBtn" class="btn btn-ghost btn-sm">
                            <i class="fa-solid fa-rotate"></i>
                        </button>
                    </div>
                </div>

                <div class="table-list" id="tableList">
                    <!-- 表项动态插入 -->
                </div>

                <div class="sticky-cta pt-2">
                    <button id="refreshTablesBtnBottom" class="btn btn-ghost w-100">
                        <i class="fa-solid fa-rotate me-2"></i> 刷新表列表
                    </button>
                </div>
            </div>
        </div>

        <!-- 右侧：字段详情 + 数据预览 -->
        <div class="col-12 col-lg-8 d-flex flex-column gap-3">

            <!-- 字段详情 -->
            <div class="card-darker">
                <div class="card-header px-3 py-2 d-flex align-items-center justify-content-between">
                    <div class="d-flex align-items-center gap-2">
                        <i class="fa-solid fa-diagram-project text-warning"></i>
                        <strong>字段详情</strong>
                        <small id="colMeta" class="ms-2 muted">未选择表</small>
                    </div>
                    <div class="d-flex align-items-center gap-2">
                        <div id="currentTablePill" class="pill d-none me-2">
                            <i class="fa-solid fa-table"></i> <span id="currentTableText"></span>
                        </div>
                        <div class="btn-group btn-group-sm" role="group">
                            <button id="designTableBtn" class="btn btn-ghost" disabled>
                                <i class="fa-solid fa-pen-ruler me-1"></i> 设计表
                            </button>
                            <button id="dropTableBtn" class="btn btn-outline-danger" disabled>
                                <i class="fa-solid fa-trash-can me-1"></i> 删除表
                            </button>
                        </div>
                    </div>
                </div>
                <div class="p-3">
                    <div class="table-responsive">
                        <table class="table table-sm table-striped table-bordered mb-0 data-table" id="columnTable">
                            <thead>
                            <tr class="text-uppercase small">
                                <th style="width:38%">字段名</th>
                                <th style="width:22%">类型</th>
                                <th>备注</th>
                            </tr>
                            </thead>
                            <tbody id="columnTableBody">
                            <tr><td colspan="3" class="empty"><i class="fa-regular fa-circle-right me-2"></i> 请选择左侧表名</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- 数据预览 -->
            <div class="card-lite">
                <div class="card-header px-3 py-2">
                    <div class="d-flex align-items-center justify-content-between">
                        <div class="d-flex align-items-center gap-2">
                            <i class="fa-solid fa-eye text-success"></i>
                            <strong>数据预览</strong>
                            <small id="previewMeta" class="ms-2 muted">未选择表</small>
                        </div>
                        <div class="toolbar d-flex align-items-center gap-2">
                            <label class="muted me-1">每页</label>
                            <select id="pageSize" class="form-select form-select-sm" style="width:90px;">
                                <option>10</option><option selected>20</option><option>50</option><option>100</option>
                            </select>

                            <label class="muted ms-2 me-1">排序</label>
                            <select id="orderBy" class="form-select form-select-sm" style="width:220px;"></select>
                            <select id="orderDir" class="form-select form-select-sm" style="width:120px;">
                                <option value="ASC">升序</option><option value="DESC">降序</option>
                            </select>
                            <button id="applyOrderBtn" class="btn btn-sm btn-acc"><i class="fa-solid fa-arrow-down-wide-short me-1"></i> 应用</button>
                        </div>
                    </div>
                </div>

                <div class="p-3">
                    <div id="rowsContainer" class="table-responsive" style="min-height:140px;">
                        <div class="empty"><i class="fa-regular fa-hand-pointer me-2"></i> 请选择左侧表名以预览数据</div>
                    </div>

                    <div class="d-flex justify-content-between align-items-center mt-3">
                        <div id="rowsPagerInfo" class="small text-weak">—</div>
                        <div class="btn-group">
                            <button id="firstPageBtn" class="btn btn-sm btn-ghost">« 首</button>
                            <button id="prevPageBtn" class="btn btn-sm btn-ghost">‹ 上一页</button>
                            <button id="nextPageBtn" class="btn btn-sm btn-ghost">下一页 ›</button>
                            <button id="downloadCsvBtn" class="btn btn-sm btn-acc ms-2"><i class="fa-solid fa-file-csv me-1"></i> 导出当前页 CSV</button>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div> <!-- /row -->
</div> <!-- /container -->

<!-- ===== 新建表 Modal ===== -->
<div class="modal fade" id="newTableModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fa-solid fa-plus me-2"></i> 新建表</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="关闭"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">表名</label>
                    <input type="text" id="newTableName" class="form-control" placeholder="例如: users" />
                </div>
                <div class="mb-2 d-flex justify-content-between align-items-center">
                    <label class="form-label mb-0">字段定义</label>
                    <button id="addNewColumnBtn" type="button" class="btn btn-sm btn-ghost">
                        <i class="fa-solid fa-plus me-1"></i> 添加字段
                    </button>
                </div>
                <div class="table-responsive">
                    <table class="table table-sm table-bordered align-middle">
                        <thead class="table-light">
                        <tr>
                            <th style="width:22%">字段名</th>
                            <th style="width:22%">类型</th>
                            <th style="width:14%">长度</th>
                            <th style="width:14%">允许为空</th>
                            <th>备注</th>
                            <th style="width:50px;"></th>
                        </tr>
                        </thead>
                        <tbody id="newTableColumnsBody">
                        </tbody>
                    </table>
                </div>
                <small class="text-muted">目前前端只收集字段信息，后端可根据此 JSON 生成对应的 CREATE TABLE 语句。</small>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-ghost" data-bs-dismiss="modal">取消</button>
                <button type="button" id="submitNewTableBtn" class="btn btn-acc">创建</button>
            </div>
        </div>
    </div>
</div>

<!-- ===== 设计表 Modal ===== -->
<div class="modal fade" id="designTableModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fa-solid fa-pen-ruler me-2"></i> 设计表：<span id="designTableTitle"></span></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="关闭"></button>
            </div>
            <div class="modal-body">
                <div class="table-responsive">
                    <table class="table table-sm table-bordered align-middle">
                        <thead class="table-light">
                        <tr>
                            <th style="width:22%">字段名</th>
                            <th style="width:22%">类型</th>
                            <th style="width:14%">长度</th>
                            <th style="width:14%">允许为空</th>
                            <th>备注</th>
                        </tr>
                        </thead>
                        <tbody id="designTableColumnsBody">
                        </tbody>
                    </table>
                </div>
                <small class="text-muted">此处只修改字段类型/长度/备注，后端可根据差异生成 ALTER TABLE。</small>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-ghost" data-bs-dismiss="modal">取消</button>
                <button type="button" id="submitDesignTableBtn" class="btn btn-acc">保存设计</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // ===== 全局状态 =====
    let currentDs = 'MYSQL';
    let currentTable = null;
    let currentPage = 1;
    let currentSize = 20;
    let currentOrderBy = null;
    let currentOrderDir = 'ASC';
    let currentColumns = [];
    let lastRowsPayload = { columns: [], rows: [] };

    // 设计表用：完整字段信息
    let currentColumnDetails = [];

    // ===== DOM =====
    const dsSelect = document.getElementById('dsSelect');
    const dsBadgeText = document.getElementById('dsBadgeText');
    const tableList = document.getElementById('tableList');
    const tableSearch = document.getElementById('tableSearch');
    const tableCount = document.getElementById('tableCount');
    const colMeta = document.getElementById('colMeta');
    const previewMeta = document.getElementById('previewMeta');
    const columnTableBody = document.getElementById('columnTableBody');
    const orderBySel = document.getElementById('orderBy');
    const orderDirSel = document.getElementById('orderDir');
    const pageSizeSel = document.getElementById('pageSize');
    const rowsBox = document.getElementById('rowsContainer');
    const pagerInfo = document.getElementById('rowsPagerInfo');
    const currentTablePill = document.getElementById('currentTablePill');
    const currentTableText = document.getElementById('currentTableText');
    const designTableBtn = document.getElementById('designTableBtn');
    const dropTableBtn = document.getElementById('dropTableBtn');
    const refreshTablesBtn = document.getElementById('refreshTablesBtn');
    const refreshTablesBtnBottom = document.getElementById('refreshTablesBtnBottom');
    const newTableBtn = document.getElementById('newTableBtn');

    // Modal & 相关 DOM
    const newTableModalEl = document.getElementById('newTableModal');
    const newTableModal = new bootstrap.Modal(newTableModalEl);
    const newTableNameInput = document.getElementById('newTableName');
    const newTableColumnsBody = document.getElementById('newTableColumnsBody');
    const addNewColumnBtn = document.getElementById('addNewColumnBtn');
    const submitNewTableBtn = document.getElementById('submitNewTableBtn');

    const designTableModalEl = document.getElementById('designTableModal');
    const designTableModal = new bootstrap.Modal(designTableModalEl);
    const designTableTitle = document.getElementById('designTableTitle');
    const designTableColumnsBody = document.getElementById('designTableColumnsBody');
    const submitDesignTableBtn = document.getElementById('submitDesignTableBtn');

    // ===== 工具 =====
    const escapeHtml = (s) => (s==null?'':String(s).replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])));
    const showSkeleton = (n=6)=>'<div class="py-2">'+Array.from({length:n}).map(()=>'<div class="skeleton mb-2"></div>').join('')+'</div>';

    // ===== 事件绑定 =====
    dsSelect.addEventListener('change', () => {
      currentDs = dsSelect.value.toUpperCase();
      dsBadgeText.textContent = currentDs;
      currentTable = null;
      renderEmptyStates();
      updateTableActionsDisabled();
      loadTables();
    });

    refreshTablesBtn.addEventListener('click', loadTables);
    refreshTablesBtnBottom.addEventListener('click', loadTables);
    tableSearch.addEventListener('input', filterTables);

    pageSizeSel.addEventListener('change', () => { currentSize = parseInt(pageSizeSel.value,10)||20; currentPage = 1; loadRows(); });
    document.getElementById('applyOrderBtn').addEventListener('click', () => {
      currentOrderBy = orderBySel.value || null;
      currentOrderDir = orderDirSel.value || 'ASC';
      currentPage = 1;
      loadRows();
    });
    document.getElementById('firstPageBtn').addEventListener('click', ()=>{ if(currentPage!==1){currentPage=1;loadRows();}});
    document.getElementById('prevPageBtn').addEventListener('click', ()=>{ if(currentPage>1){currentPage--;loadRows();}});
    document.getElementById('nextPageBtn').addEventListener('click', ()=>{ currentPage++; loadRows();});
    document.getElementById('downloadCsvBtn').addEventListener('click', downloadCsvOfCurrentPage);

    // 返回主页
    document.getElementById('goHomeBtn').addEventListener('click', () => {
      window.location.href = 'index.html';
    });

    // 新建表按钮
    newTableBtn.addEventListener('click', () => {
      resetNewTableForm();
      newTableModal.show();
    });
    addNewColumnBtn.addEventListener('click', () => {
      addNewTableColumnRow();
    });
    submitNewTableBtn.addEventListener('click', submitNewTable);

    // 设计表 & 删除表
    designTableBtn.addEventListener('click', openDesignTableModal);
    dropTableBtn.addEventListener('click', dropCurrentTable);
    submitDesignTableBtn.addEventListener('click', submitDesignTable);

    // ===== 初始化（支持 ?ds=DM8）=====
    (function init(){
      const params = new URLSearchParams(location.search);
      const ds = params.get('ds');
      if (ds) { dsSelect.value = ds.toUpperCase(); currentDs = ds.toUpperCase(); dsBadgeText.textContent = currentDs; }
      renderEmptyStates();
      updateTableActionsDisabled();
      loadTables();
    })();

    // ===== 渲染空态 =====
    function renderEmptyStates(){
      columnTableBody.innerHTML = '<tr><td colspan="3" class="empty"><i class="fa-regular fa-circle-right me-2"></i> 请选择左侧表名</td></tr>';
      rowsBox.innerHTML = '<div class="empty"><i class="fa-regular fa-hand-pointer me-2"></i> 请选择左侧表名以预览数据</div>';
      pagerInfo.textContent = '—';
      previewMeta.textContent = '未选择表';
      colMeta.textContent = '未选择表';
      currentTablePill.classList.add('d-none');
    }

    function updateTableActionsDisabled(){
      const disabled = !currentTable;
      designTableBtn.disabled = disabled;
      dropTableBtn.disabled = disabled;
    }

    // ===== 加载表列表 =====
    async function loadTables(){
      tableList.innerHTML = showSkeleton(8);
      tableCount.innerHTML = '<i class="fa-solid fa-hashtag"></i> ...';
      try{
        const resp = await fetch(`/api/datasources/${currentDs}/tables`);
        const data = await resp.json();
        const items = Array.isArray(data) ? data : [];
        const rows = items.map(row => ({
          name: row.tableName || row.TABLE_NAME || Object.values(row)[0]
        })).filter(r=>!!r.name);

        tableList.innerHTML = '';
        rows.forEach(r=>{
          const li = document.createElement('div');
          li.className = 'table-list-item';
          li.innerHTML = `
            <div class="icon-chip"><i class="fa-solid fa-table"></i></div>
            <div class="flex-grow-1">
              <div class="name">${escapeHtml(r.name)}</div>
              <div class="meta">${escapeHtml(currentDs)}</div>
            </div>`;
          li.addEventListener('click', ()=>{
            tableList.querySelectorAll('.table-list-item').forEach(x=>x.classList.remove('active'));
            li.classList.add('active');
            loadColumns(currentDs, r.name);
            onTableSelected(r.name);
          });
          tableList.appendChild(li);
        });

        tableCount.innerHTML = `<i class="fa-solid fa-hashtag"></i> ${rows.length}`;
        filterTables();

      }catch(e){
        tableList.innerHTML = `<div class="empty text-danger"><i class="fa-regular fa-circle-xmark me-2"></i> 加载失败：${escapeHtml(e.message||e)}</div>`;
        tableCount.innerHTML = `<i class="fa-solid fa-hashtag"></i> 0`;
      }
    }

    // 搜索过滤
    function filterTables(){
      const q = (tableSearch.value||'').toLowerCase();
      const items = tableList.querySelectorAll('.table-list-item');
      let shown = 0;
      items.forEach(it=>{
        const name = it.querySelector('.name')?.textContent?.toLowerCase() || '';
        const ok = !q || name.includes(q);
        it.style.display = ok ? '' : 'none';
        if(ok) shown++;
      });
      tableCount.innerHTML = `<i class="fa-solid fa-hashtag"></i> ${shown}`;
    }

    // ===== 载入字段 =====
    async function loadColumns(type, tableName){
      colMeta.textContent = `${type} · ${tableName}`;
      currentTableText.textContent = tableName;
      currentTablePill.classList.remove('d-none');
      columnTableBody.innerHTML = `<tr><td colspan="3">${showSkeleton(6)}</td></tr>`;
      try{
        const resp = await fetch(`/api/datasources/${encodeURIComponent(type)}/tables/${encodeURIComponent(tableName)}`);
        const data = await resp.json();
        const rows = Array.isArray(data) ? data : [];
        currentColumnDetails = rows.map(col => ({
          name: col.Field || col.COLUMN_NAME || '',
          type: col.Type || col.DATA_TYPE || '',
          length: col.COLUMN_SIZE || col.LENGTH || null,
          nullable: (col.Null === 'YES') || (col.IS_NULLABLE === 'YES') || false,
          comment: col.Comment || col.COMMENTS || ''
        }));
        columnTableBody.innerHTML = rows.map(col=>{
          const name = col.Field || col.COLUMN_NAME || '';
          const type = col.Type || col.DATA_TYPE || '';
          const cmt  = col.Comment || col.COMMENTS || '';
          return `<tr>
            <td>${escapeHtml(name)}</td>
            <td class="text-weak">${escapeHtml(type)}</td>
            <td class="text-weak">${escapeHtml(cmt||'')}</td>
          </tr>`;
        }).join('') || `<tr><td colspan="3" class="empty">未获取到字段信息</td></tr>`;
      }catch(e){
        columnTableBody.innerHTML = `<tr><td colspan="3" class="empty text-danger"><i class="fa-regular fa-circle-xmark me-2"></i> 加载失败：${escapeHtml(e.message||e)}</td></tr>`;
      }
    }

    // ===== 选表后加载排序字段 + 数据 =====
    async function onTableSelected(tableName){
      currentTable = tableName; currentPage = 1;
      updateTableActionsDisabled();
      await loadColumnsForOrder();
      await loadRows();
    }

    async function loadColumnsForOrder(){
      if(!currentTable) return;
      orderBySel.innerHTML = `<option value="">（加载中…）</option>`;
      try{
        const res = await fetch(`/api/datasources/${encodeURIComponent(currentDs)}/tables/${encodeURIComponent(currentTable)}/columns`);
        const data = await res.json();
        currentColumns = Array.isArray(data) ? data.map(c => c.columnName || c.COLUMN_NAME || c.name) : [];
        orderBySel.innerHTML = `<option value="">（不排序）</option>` +
          currentColumns.map(c => `<option value="${escapeHtml(c)}">${escapeHtml(c)}</option>`).join('');
      }catch{
        orderBySel.innerHTML = `<option value="">（不排序）</option>`;
      }
    }

    // ===== 加载数据行 =====
    async function loadRows(){
      if(!currentTable){
        rowsBox.innerHTML = '<div class="empty">请选择左侧表名以预览数据</div>';
        pagerInfo.textContent = '—'; return;
      }
      previewMeta.textContent = `${currentDs} · ${currentTable}`;
      rowsBox.innerHTML = `<div class="p-2">${showSkeleton(10)}</div>`;
      pagerInfo.textContent = '加载中…';

      const params = new URLSearchParams();
      params.set('page', String(currentPage));
      params.set('size', String(currentSize));
      if(currentOrderBy) params.set('orderBy', currentOrderBy);
      if(currentOrderDir) params.set('orderDir', currentOrderDir);

      const url = `/api/datasources/${encodeURIComponent(currentDs)}/tables/${encodeURIComponent(currentTable)}/rows?${params.toString()}`;
      try{
        const resp = await fetch(url, { headers:{'Accept':'application/json'} });
        const json = await resp.json();
        if(!json.success) throw new Error(json.message || '加载失败');

        const rows = json.rows || [];
        const cols = json.columns || (rows[0] ? Object.keys(rows[0]) : []);
        lastRowsPayload = { columns: cols, rows };

        rowsBox.innerHTML = renderRowsTable(cols, rows);
        const total = json.total || 0;
        const from = total === 0 ? 0 : (json.page - 1) * json.size + 1;
        const to   = Math.min(json.page * json.size, total);
        pagerInfo.textContent = `第 ${json.page} 页 · 本页 ${rows.length} 条 · 总计 ${total} 条 · 显示 ${from}–${to}`;
      }catch(e){
        rowsBox.innerHTML = `<div class="empty text-danger"><i class="fa-regular fa-circle-xmark me-2"></i> 加载失败：${escapeHtml(e.message||e)}</div>`;
        pagerInfo.textContent = '—';
      }
    }

    function renderRowsTable(columns, rows){
      if(!rows || rows.length===0){
        return `<div class="empty"><i class="fa-regular fa-folder-open me-2"></i> 无数据</div>`;
      }
      const thead = `<thead><tr>${columns.map(c=>`<th class="text-uppercase small">${escapeHtml(c)}</th>`).join('')}</tr></thead>`;
      const tbody = `<tbody>${
        rows.map(r=>`<tr>${
          columns.map(c=>{
            let v = r[c]; v = (v==null)?'':String(v);
            const short = v.length>120 ? v.slice(0,120)+'…' : v;
            return `<td title="${escapeHtml(v)}">${escapeHtml(short)}</td>`;
          }).join('')
        }</tr>`).join('')
      }</tbody>`;
      return `<table class="table table-sm table-striped table-bordered mb-0">${thead}${tbody}</table>`;
    }

    // ===== 导出当前页 CSV =====
    function downloadCsvOfCurrentPage(){
      const {columns, rows} = lastRowsPayload || {};
      if(!columns || !rows || rows.length===0){ alert('当前页暂无数据可导出'); return; }
      const esc = (s)=> `"${String(s??'').replace(/"/g,'""')}"`;
      const header = columns.map(esc).join(',');
      const body = rows.map(r => columns.map(c=>esc(r[c])).join(',')).join('\n');
      const csv = header + '\n' + body;
      const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `${currentTable || 'data'}_page${currentPage}.csv`;
      document.body.appendChild(a); a.click(); a.remove();
      setTimeout(()=>URL.revokeObjectURL(a.href), 1000);
    }

    // ===== 新建表：前端表单处理 =====
    function resetNewTableForm(){
      newTableNameInput.value = '';
      newTableColumnsBody.innerHTML = '';
      // 默认给两行字段，方便用户体验
      addNewTableColumnRow('id', 'INT', '11', false, '主键');
      addNewTableColumnRow('name', 'VARCHAR', '255', true, '名称');
    }

    function addNewTableColumnRow(name='', type='VARCHAR', length='255', nullable=true, comment=''){
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td><input type="text" class="form-control form-control-sm col-name" value="${escapeHtml(name)}" /></td>
        <td><input type="text" class="form-control form-control-sm col-type" value="${escapeHtml(type)}" placeholder="例如: INT / VARCHAR" /></td>
        <td><input type="number" class="form-control form-control-sm col-length" value="${escapeHtml(length)}" /></td>
        <td class="text-center">
          <input type="checkbox" class="form-check-input col-nullable" ${nullable?'checked':''} />
        </td>
        <td><input type="text" class="form-control form-control-sm col-comment" value="${escapeHtml(comment)}" /></td>
        <td class="text-center">
          <button type="button" class="btn btn-sm btn-link text-danger col-remove">
            <i class="fa-solid fa-xmark"></i>
          </button>
        </td>
      `;
      tr.querySelector('.col-remove').addEventListener('click', () => {
        tr.remove();
      });
      newTableColumnsBody.appendChild(tr);
    }

    async function submitNewTable(){
      const tableName = newTableNameInput.value.trim();
      if(!tableName){
        alert('请填写表名'); return;
      }
      const rows = Array.from(newTableColumnsBody.querySelectorAll('tr'));
      if(rows.length === 0){
        alert('请至少添加一个字段'); return;
      }
      const columns = rows.map(tr => {
        return {
          name: tr.querySelector('.col-name').value.trim(),
          type: tr.querySelector('.col-type').value.trim() || 'VARCHAR',
          length: parseInt(tr.querySelector('.col-length').value,10) || null,
          nullable: tr.querySelector('.col-nullable').checked,
          comment: tr.querySelector('.col-comment').value.trim()
        };
      }).filter(c => c.name);

      if(columns.length === 0){
        alert('请至少定义一个有效字段名'); return;
      }

      const payload = { tableName, columns };
      try{
        const resp = await fetch(`/api/datasources/${encodeURIComponent(currentDs)}/tables`, {
          method: 'POST',
          headers: { 'Content-Type':'application/json' },
          body: JSON.stringify(payload)
        });
        const json = await resp.json();
        if(!json.success){
          throw new Error(json.message || '创建表失败');
        }
        alert('创建表成功');
        newTableModal.hide();
        loadTables();
      }catch(e){
        alert('创建表失败：'+(e.message || e));
      }
    }

    // ===== 设计表：打开和提交 =====
    function openDesignTableModal(){
      if(!currentTable){
        alert('请先选择表'); return;
      }
      designTableTitle.textContent = `${currentDs} · ${currentTable}`;
      designTableColumnsBody.innerHTML = '';

      if(!currentColumnDetails || currentColumnDetails.length===0){
        designTableColumnsBody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">当前未加载字段信息</td></tr>';
      }else{
        currentColumnDetails.forEach(col => {
          const tr = document.createElement('tr');
          const name = col.name || '';
          // 简单拆分 type (如 "varchar(255)" -> VARCHAR + 255)
          let type = col.type || '';
          let baseType = type;
          let length = col.length || '';
          const m = type.match(/^([a-zA-Z]+)\s*\((\d+)\)/);
          if(m){
            baseType = m[1].toUpperCase();
            if(!length) length = m[2];
          }
          tr.innerHTML = `
            <td><input type="text" class="form-control form-control-sm col-name" value="${escapeHtml(name)}" disabled /></td>
            <td><input type="text" class="form-control form-control-sm col-type" value="${escapeHtml(baseType)}" /></td>
            <td><input type="number" class="form-control form-control-sm col-length" value="${escapeHtml(length || '')}" /></td>
            <td class="text-center">
              <input type="checkbox" class="form-check-input col-nullable" ${col.nullable?'checked':''} />
            </td>
            <td><input type="text" class="form-control form-control-sm col-comment" value="${escapeHtml(col.comment || '')}" /></td>
          `;
          designTableColumnsBody.appendChild(tr);
        });
      }

      designTableModal.show();
    }

    async function submitDesignTable(){
      if(!currentTable){
        alert('未选择表'); return;
      }
      const rows = Array.from(designTableColumnsBody.querySelectorAll('tr'));
      if(rows.length === 0){
        alert('没有可提交的字段'); return;
      }
      const columns = rows.map(tr => ({
        name: tr.querySelector('.col-name').value.trim(),
        type: tr.querySelector('.col-type').value.trim() || 'VARCHAR',
        length: parseInt(tr.querySelector('.col-length').value,10) || null,
        nullable: tr.querySelector('.col-nullable').checked,
        comment: tr.querySelector('.col-comment').value.trim()
      }));

      const payload = { tableName: currentTable, columns };
      try{
        const resp = await fetch(`/api/datasources/${encodeURIComponent(currentDs)}/tables/${encodeURIComponent(currentTable)}`, {
          method: 'PUT',
          headers: { 'Content-Type':'application/json' },
          body: JSON.stringify(payload)
        });
        const json = await resp.json();
        if(!json.success){
          throw new Error(json.message || '保存设计失败');
        }
        alert('表设计已保存');
        designTableModal.hide();
        // 重新加载字段信息
        loadColumns(currentDs, currentTable);
      }catch(e){
        alert('保存设计失败：'+(e.message || e));
      }
    }

    // ===== 删除表 =====
    async function dropCurrentTable(){
      if(!currentTable){
        alert('请先选择表'); return;
      }
      if(!confirm(`确定要删除表 "${currentTable}" 吗？此操作不可恢复！`)){
        return;
      }
      try{
        const resp = await fetch(`/api/datasources/${encodeURIComponent(currentDs)}/tables/${encodeURIComponent(currentTable)}`, {
          method: 'DELETE'
        });
        const json = await resp.json();
        if(!json.success){
          throw new Error(json.message || '删除表失败');
        }
        alert('删除表成功');
        currentTable = null;
        currentColumnDetails = [];
        renderEmptyStates();
        updateTableActionsDisabled();
        loadTables();
      }catch(e){
        alert('删除表失败：'+(e.message || e));
      }
    }
</script>
</body>
</html>
